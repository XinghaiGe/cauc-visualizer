<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排序算法可视化教学系统</title>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 10px;
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        .container-fluid { height: 100vh; padding: 10px; }
        .chart-container { 
            height: 300px; 
            border: 2px solid #dee2e6; 
            border-radius: 8px;
            background: white;
        }
        .code-container { 
            height: 300px; 
            overflow-y: auto; 
            border: 2px solid #dee2e6; 
            border-radius: 8px;
            background: #f8f9fa;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
        .code-line { 
            padding: 2px 8px; 
            margin: 0;
            line-height: 1.4;
        }
        .highlight { 
            background-color: #fff3cd !important; 
            border-left: 4px solid #ffc107;
        }
        .controls { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend { 
            font-size: 12px; 
            background: white; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #dee2e6;
        }
        .legend-item { 
            display: inline-flex; 
            align-items: center; 
            margin-right: 15px; 
            margin-bottom: 5px;
        }
        .legend-color { 
            width: 16px; 
            height: 16px; 
            margin-right: 6px; 
            border-radius: 3px;
        }
        .btn-sm { font-size: 12px; padding: 4px 8px; }
        .status-info { 
            background: #e3f2fd; 
            padding: 8px; 
            border-radius: 6px; 
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100">
            <!-- 左侧控制面板 -->
            <div class="col-md-3">
                <div class="controls mb-3">
                    <h5 class="mb-3">排序算法选择</h5>
                    <select id="algorithmSelect" class="form-select mb-3">
                        <option value="shell">希尔排序</option>
                        <option value="heap">堆排序</option>
                        <option value="quick">快速排序</option>
                    </select>
                    
                    <div class="d-grid gap-2 mb-3">
                        <button id="initBtn" class="btn btn-primary btn-sm">初始化数组</button>
                        <button id="startBtn" class="btn btn-success btn-sm">开始排序</button>
                    </div>
                    
                    <div class="btn-group w-100 mb-3">
                        <button id="prevBtn" class="btn btn-outline-secondary btn-sm" disabled>上一步</button>
                        <button id="nextBtn" class="btn btn-outline-secondary btn-sm" disabled>下一步</button>
                        <button id="stopBtn" class="btn btn-danger btn-sm" disabled>停止</button>
                    </div>
                </div>

                <div class="status-info mb-3">
                    <div><strong>当前步骤:</strong> <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <div><strong>操作描述:</strong></div>
                    <div id="stepDescription">请选择算法并初始化</div>
                </div>

                <div class="legend">
                    <h6>颜色说明</h6>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>默认</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>比较</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>交换</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #27ae60;"></div>
                        <span>已排序</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span>基准值</span>
                    </div>
                </div>
            </div>

            <!-- 右侧可视化区域 -->
            <div class="col-md-9">
                <div class="row h-100">
                    <div class="col-12 mb-3">
                        <h6>数组可视化</h6>
                        <div id="chartContainer" class="chart-container"></div>
                    </div>
                    <div class="col-12">
                        <h6>代码执行</h6>
                        <div id="codeContainer" class="code-container">
                            <pre id="codeDisplay"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SortingVisualizer {
            constructor() {
                this.array = [];
                this.steps = [];
                this.currentStep = 0;
                this.chart = null;
                this.algorithms = {
                    shell: this.shellSort.bind(this),
                    heap: this.heapSort.bind(this),
                    quick: this.quickSort.bind(this)
                };
                this.algorithmCodes = {
                    shell: [
                        "function shellSort(arr) {",
                        "    let n = arr.length;",
                        "    for (let gap = Math.floor(n/2); gap > 0; gap = Math.floor(gap/2)) {",
                        "        for (let i = gap; i < n; i++) {",
                        "            let temp = arr[i];",
                        "            let j;",
                        "            for (j = i; j >= gap && arr[j-gap] > temp; j -= gap) {",
                        "                arr[j] = arr[j-gap];",
                        "            }",
                        "            arr[j] = temp;",
                        "        }",
                        "    }",
                        "}"
                    ],
                    heap: [
                        "function heapSort(arr) {",
                        "    let n = arr.length;",
                        "    for (let i = Math.floor(n/2) - 1; i >= 0; i--) {",
                        "        heapify(arr, n, i);",
                        "    }",
                        "    for (let i = n-1; i > 0; i--) {",
                        "        [arr[0], arr[i]] = [arr[i], arr[0]];",
                        "        heapify(arr, i, 0);",
                        "    }",
                        "}",
                        "function heapify(arr, n, i) {",
                        "    let largest = i;",
                        "    let left = 2*i + 1;",
                        "    let right = 2*i + 2;",
                        "    if (left < n && arr[left] > arr[largest]) largest = left;",
                        "    if (right < n && arr[right] > arr[largest]) largest = right;",
                        "    if (largest !== i) {",
                        "        [arr[i], arr[largest]] = [arr[largest], arr[i]];",
                        "        heapify(arr, n, largest);",
                        "    }",
                        "}"
                    ],
                    quick: [
                        "function quickSort(arr, low, high) {",
                        "    if (low < high) {",
                        "        let pi = partition(arr, low, high);",
                        "        quickSort(arr, low, pi - 1);",
                        "        quickSort(arr, pi + 1, high);",
                        "    }",
                        "}",
                        "function partition(arr, low, high) {",
                        "    let pivot = arr[high];",
                        "    let i = low - 1;",
                        "    for (let j = low; j < high; j++) {",
                        "        if (arr[j] < pivot) {",
                        "            i++;",
                        "            [arr[i], arr[j]] = [arr[j], arr[i]];",
                        "        }",
                        "    }",
                        "    [arr[i + 1], arr[high]] = [arr[high], arr[i + 1]];",
                        "    return i + 1;",
                        "}"
                    ]
                };
                this.init();
            }

            init() {
                this.initializeArray();
                this.setupEventListeners();
                this.updateCodeDisplay();
                this.updateChart();
            }

            initializeArray() {
                this.array = Array.from({length: 10}, () => Math.floor(Math.random() * 100) + 1);
                this.steps = [];
                this.currentStep = 0;
                this.updateStepInfo();
            }

            setupEventListeners() {
                document.getElementById('initBtn').addEventListener('click', () => {
                    this.initializeArray();
                    this.updateChart();
                    this.resetButtons();
                });

                document.getElementById('startBtn').addEventListener('click', () => {
                    const algorithm = document.getElementById('algorithmSelect').value;
                    this.generateSteps(algorithm);
                    this.enableStepButtons();
                });

                document.getElementById('prevBtn').addEventListener('click', () => this.previousStep());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopSorting());

                document.getElementById('algorithmSelect').addEventListener('change', () => {
                    this.updateCodeDisplay();
                    this.resetButtons();
                });
            }

            generateSteps(algorithm) {
                this.steps = [];
                const arrayCopy = [...this.array];
                
                if (algorithm === 'shell') {
                    this.shellSort(arrayCopy);
                } else if (algorithm === 'heap') {
                    this.heapSort(arrayCopy);
                } else if (algorithm === 'quick') {
                    this.quickSort(arrayCopy, 0, arrayCopy.length - 1);
                }

                this.currentStep = 0;
                this.updateStepInfo();
            }

            shellSort(arr) {
                let n = arr.length;
                for (let gap = Math.floor(n/2); gap > 0; gap = Math.floor(gap/2)) {
                    this.addStep([...arr], [], `设置间隔gap = ${gap}`, 3);
                    for (let i = gap; i < n; i++) {
                        let temp = arr[i];
                        this.addStep([...arr], [i], `选择元素 arr[${i}] = ${temp}`, 4);
                        let j;
                        for (j = i; j >= gap && arr[j-gap] > temp; j -= gap) {
                            this.addStep([...arr], [j, j-gap], `比较 arr[${j-gap}] = ${arr[j-gap]} > ${temp}`, 7);
                            arr[j] = arr[j-gap];
                            this.addStep([...arr], [j], `移动 arr[${j}] = ${arr[j]}`, 8);
                        }
                        arr[j] = temp;
                        this.addStep([...arr], [j], `插入 arr[${j}] = ${temp}`, 10);
                    }
                }
                this.addStep([...arr], [], '排序完成', 12);
            }

            heapSort(arr) {
                let n = arr.length;
                
                for (let i = Math.floor(n/2) - 1; i >= 0; i--) {
                    this.addStep([...arr], [i], `构建最大堆，从节点 ${i} 开始`, 3);
                    this.heapify(arr, n, i);
                }

                for (let i = n-1; i > 0; i--) {
                    this.addStep([...arr], [0, i], `交换堆顶和末尾元素`, 6);
                    [arr[0], arr[i]] = [arr[i], arr[0]];
                    this.addStep([...arr], [i], `元素 ${arr[i]} 已排序`, 6);
                    this.heapify(arr, i, 0);
                }
                this.addStep([...arr], [], '排序完成', 8);
            }

            heapify(arr, n, i) {
                let largest = i;
                let left = 2*i + 1;
                let right = 2*i + 2;

                this.addStep([...arr], [i], `调整堆，根节点索引 ${i}`, 11);

                if (left < n && arr[left] > arr[largest]) {
                    largest = left;
                    this.addStep([...arr], [left, largest], `左子节点更大`, 14);
                }

                if (right < n && arr[right] > arr[largest]) {
                    largest = right;
                    this.addStep([...arr], [right, largest], `右子节点更大`, 15);
                }

                if (largest !== i) {
                    this.addStep([...arr], [i, largest], `交换节点 ${i} 和 ${largest}`, 17);
                    [arr[i], arr[largest]] = [arr[largest], arr[i]];
                    this.addStep([...arr], [largest], `继续调整子堆`, 18);
                    this.heapify(arr, n, largest);
                }
            }

            quickSort(arr, low, high) {
                if (low < high) {
                    this.addStep([...arr], [], `快速排序范围 [${low}, ${high}]`, 2);
                    let pi = this.partition(arr, low, high);
                    this.addStep([...arr], [pi], `基准位置确定为 ${pi}`, 3);
                    this.quickSort(arr, low, pi - 1);
                    this.quickSort(arr, pi + 1, high);
                }
            }

            partition(arr, low, high) {
                let pivot = arr[high];
                this.addStep([...arr], [high], `选择基准值 ${pivot}`, 8);
                let i = low - 1;

                for (let j = low; j < high; j++) {
                    this.addStep([...arr], [j, high], `比较 arr[${j}] = ${arr[j]} 与基准值 ${pivot}`, 10);
                    if (arr[j] < pivot) {
                        i++;
                        this.addStep([...arr], [i, j], `交换 arr[${i}] 和 arr[${j}]`, 12);
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                        this.addStep([...arr], [i, j], `交换完成`, 12);
                    }
                }
                this.addStep([...arr], [i + 1, high], `基准值归位`, 15);
                [arr[i + 1], arr[high]] = [arr[high], arr[i + 1]];
                this.addStep([...arr], [i + 1], `基准值已就位`, 15);
                return i + 1;
            }

            addStep(array, highlights, description, lineNumber) {
                this.steps.push({
                    array: [...array],
                    highlights: [...highlights],
                    description,
                    lineNumber: lineNumber || 0
                });
            }

            updateChart() {
                const step = this.steps[this.currentStep] || { array: this.array, highlights: [] };
                const dataPoints = step.array.map((value, index) => {
                    let color = "#3498db";
                    if (step.highlights && step.highlights.includes(index)) {
                        if (step.description.includes('比较')) color = "#e74c3c";
                        else if (step.description.includes('交换')) color = "#f39c12";
                        else if (step.description.includes('已排序')) color = "#27ae60";
                        else if (step.description.includes('基准')) color = "#9b59b6";
                        else color = "#f39c12";
                    }
                    return {
                        label: `${index}`,
                        y: value,
                        color: color
                    };
                });

                const options = {
                    animationEnabled: true,
                    theme: "light2",
                    title: { text: "数组可视化", fontSize: 16 },
                    axisY: { title: "数值", titleFontSize: 12 },
                    axisX: { title: "索引", titleFontSize: 12 },
                    data: [{
                        type: "column",
                        indexLabel: "{y}",
                        indexLabelFontSize: 11,
                        dataPoints: dataPoints
                    }]
                };

                if (!this.chart) {
                    this.chart = new CanvasJS.Chart("chartContainer", options);
                } else {
                    this.chart.options = options;
                }
                this.chart.render();
            }

            updateCodeDisplay() {
                const algorithm = document.getElementById('algorithmSelect').value;
                const code = this.algorithmCodes[algorithm];
                const codeHtml = code.map((line, index) => 
                    `<div class="code-line" data-line="${index + 1}">${index + 1}: ${line}</div>`
                ).join('');
                document.getElementById('codeDisplay').innerHTML = codeHtml;
            }

            highlightCodeLine(lineNumber) {
                document.querySelectorAll('.code-line').forEach(line => 
                    line.classList.remove('highlight'));
                
                if (lineNumber > 0) {
                    const targetLine = document.querySelector(`[data-line="${lineNumber}"]`);
                    if (targetLine) {
                        targetLine.classList.add('highlight');
                        targetLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }

            updateStepInfo() {
                document.getElementById('currentStep').textContent = this.currentStep;
                document.getElementById('totalSteps').textContent = this.steps.length;
                
                const step = this.steps[this.currentStep];
                if (step) {
                    document.getElementById('stepDescription').textContent = step.description;
                    this.highlightCodeLine(step.lineNumber);
                } else {
                    document.getElementById('stepDescription').textContent = '请开始排序';
                    this.highlightCodeLine(0);
                }
            }

            previousStep() {
                if (this.currentStep > 0) {
                    this.currentStep--;
                    this.updateChart();
                    this.updateStepInfo();
                }
                this.updateButtonStates();
            }

            nextStep() {
                if (this.currentStep < this.steps.length - 1) {
                    this.currentStep++;
                    this.updateChart();
                    this.updateStepInfo();
                }
                this.updateButtonStates();
            }

            stopSorting() {
                this.currentStep = 0;
                this.steps = [];
                this.updateChart();
                this.updateStepInfo();
                this.resetButtons();
            }

            enableStepButtons() {
                document.getElementById('prevBtn').disabled = false;
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                this.updateButtonStates();
            }

            resetButtons() {
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
            }

            updateButtonStates() {
                document.getElementById('prevBtn').disabled = this.currentStep <= 0;
                document.getElementById('nextBtn').disabled = this.currentStep >= this.steps.length - 1;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new SortingVisualizer();
        });
    </script>
</body>
</html>